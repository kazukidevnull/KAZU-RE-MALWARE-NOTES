This document contains various things that is handy to keep as quick references whe using or creating yara rules


## Standard yara rule template

 rule {name} {
    meta:
      description = ""
      license = ""
      author = ""
      reference = ""
      date = ""
      ATP: ""
    strings:
       
    condition:
        
}

--------------------------------------------------------------
## Creating rules based on SHA256 hashes: 

YARA is not the best tool to scan files with hashes as IOCs. YARA is designed to use pattern matching to scan malware, and early versions of YARA did not even have the capability to use cryptographic hashes. In later versions, a hash module was introduced to provide this capability.

A simple rule to match files based on a SHA256 IOC can be implemented like this:

import "hash"</p>
<p style="text-align:justify;">rule {Rule name} {
condition:
hash.sha256(0, filesize) == "{Hash string here}"
}

Line 1 imports the hash module, which we need to calculate the SHA256 value of the content of a file.

the `hash.sha256(0, filesize)` creates a SHA256 hash of the file to be compared against the provided hash . Remark that string comparison is case-sensitive, and that the cryptographic hash functions of the hash module return the hash values as lowercase hexadecimal strings. Hence, we have to provide the IOC hash as a lowercase string.

Using this simple rule to scan the C: drive of a Windows workstation in search of hit will take time: the YARA engine has to completely read each file on the disk to calculate its SHA256 value.

This can be optimized by writing a rule that will not hash files that can not possibly yield the hash we are looking for. One method to achieve this, is to first check the file size of a file and only calculate the SHA256 hash if the file size corresponds to the file size of the compromised executable.

This is possible by doing this:

import "hash"</p>
<p style="text-align:justify;">rule {Rule name} {
condition:
filesize == {filesize in bytes} and hash.sha256(0, filesize) == "Hash string here"
}

In this rule, we first compare the filesize variable and then we calculate the hash. Because the "and" operator uses lazy evaluation, the right-side operand will only be evaluated if the left-side operator is true.


If you do not know the exact size range, you can write the rule like follow to provide a range to match against:

import "hash"</p>
<p style="text-align:justify;">rule {Rule name} {
condition:
filesize &amp;gt;= 9.33 * 1024 * 1024 and filesize &amp;lt;= 9.35 * 1024 * 1024 and hash.sha256(0, filesize) == "{Sha256 hash}"
}

This rule will first check if the file size is between 9.33MB and 9.35MB (1024 * 1024 is 1 MB) and if true, then calculate the hash.
-------------------------------------------------------